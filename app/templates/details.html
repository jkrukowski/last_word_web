{% extends "layout.html" %}
{% block body %}
<script>
function createPlot(name, lab, dataSeries, labels, elementId) {
    var data = {
        labels: lab,
        name: name,
        datasets: [
            {
                label: labels[0],
                lineColor: "rgba(220,220,220,1)",
                fillColor: "rgba(220,220,220,1)",
                strokeColor: "rgba(220,220,220,1)",
                pointColor: "rgba(220,220,220,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(220,220,220,1)",
                data: dataSeries[0]
            },
            {
                label: labels[1],
                lineColor: "rgba(151,187,205,1)",
                fillColor: "rgba(151,187,205,1)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(151,187,205,1)",
                data: dataSeries[1]
            }
        ]
    };
    var options = { };
    var ctx = document.getElementById(elementId).getContext("2d");
    return new Chart(ctx).Bar(data, options);
}

$(function() {

    // validate score filter
    $('#applyFilterButton').click(function() {
        var val = parseFloat($("#scoreFilter").val());
        var parseError = isNaN(val);
        if (parseError) {
            $('#scoreFilter').parent().addClass('has-error');
        } else {
            $('#scoreFilter').parent().removeClass('has-error');
        }
        return !parseError;
    });

  // add event to button
  $('#toogleGraphs').click(function() {
    var area = $('#graphArea1');
    if (area.is(":visible")) {
      area.slideUp();
      $(this).text('Show graphs');
    } else {
      area.slideDown();
      $(this).text('Hide graphs');
    }
    return false;
  });

  // generate plots
  var plot1 = createPlot(
    "Race",
    {{ all_plot.race.lab|tojson|safe }},
    [{{ all_plot.race.val|tojson|safe }}, {{ user_plot.race.val|tojson|safe }}],
    ["Race series 1", "Race series 2"],
    "firstChart"
  );
  var plot2 = createPlot(
    "Age",
    {{ all_plot.age.lab|tojson|safe }},
    [{{ all_plot.age.val|tojson|safe }}, {{ user_plot.age.val|tojson|safe }}],
    ["Age Series 1", "Age Series 2"],
    "secondChart"
  );
  var plot3 = createPlot(
    "Year",
    {{ all_plot.year.lab|tojson|safe }},
    [{{ all_plot.year.val|tojson|safe }}, {{ user_plot.year.val|tojson|safe }}],
    ["Year Plot 1", "Year Plot 2"],
    "thirdChart"
  );

    var data = {
        name: "Score Plot",
        labels: {{ score_plot.lab|tojson|safe }},
        datasets: [
            {
                lineColor: "rgba(151,187,205,1)",
                fillColor: "rgba(151,187,205,1)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(151,187,205,1)",
                data: {{ score_plot.val|tojson|safe }}
            }
        ]
    };
    var options = {
        showTooltips: false,
        datasetStroke: false,
        pointDot: false,

    };
    var ctx = document.getElementById("scoreChart").getContext("2d");
    var chart = new Chart(ctx).Line(data, options);

  // $("#plot1Legend").html(plot1.generateLegend());
  // $("#plot2Legend").html(plot2.generateLegend());
  // $("#plot3Legend").html(plot3.generateLegend());
});
</script>
<div id="filterModal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Score Filter</h4>
      </div>
      <form action="{{ url_for('user_query') }}" method="get" role="form">
          <div class="modal-body">

                <div class="form-group">
                    <label for="currentQuery">Current query</label>
                    <input id="currentQuery" type="text" class="form-control" placeholder="{{ user_input }}" value="{{ user_input }}" name="q" readonly>
                </div>
                <div class="form-group">
                    <label for="scoreFilter">Minimal query score</label>
                    <input id="scoreFilter" type="text" class="form-control" placeholder="{{ score_threshold }}" name="min">
                </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="applyFilterButton" type="submit" class="btn btn-primary">Apply filter</button>
          </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="page-header">
    <h1>Last Words <small>of every inmate executed in Texas since 1984</small></h1>
</div>
<div class="row">
    <div class="col-md-8">
        <p class="lead">Results for: <strong>{{ user_input }}</strong>, minimal score: <strong>{{ score_threshold }}</strong></p>
    </div>
    <div class="col-md-4 text-right">
        <a id="toogleGraphs" class="btn btn-primary" href="#" role="button">Show graphs</a>
        <a class="btn btn-default" data-toggle="modal" data-target="#filterModal">Enter score filter</a>
        <a class="btn btn-default" href="{{ url_for('main_page') }}" role="button">New query</a>
    </div>
</div>
<div id="graphArea1" class="row" style="display: none;">
    <div class="col-md-4">
        <h4>Inmate Race Distribution</h4>
        <canvas id="firstChart" width="360" height="360"></canvas>
        <h6 id="plot1Legend"></h6>
    </div>
    <div class="col-md-4">
        <h4>Inmate Age Distribution</h4>
        <canvas id="secondChart" width="360" height="360"></canvas>
        <h6 id="plot2Legend"></h6>
    </div>
    <div class="col-md-4">
        <h4>Executions By Year</h4>
        <canvas id="thirdChart" width="360" height="360"></canvas>
        <h6 id="plot3Legend"></h6>
    </div>
    <div class="col-md-12">
        <h4>Scores By User</h4>
        <canvas id="scoreChart" width="1140" height="360"></canvas>
        <h6 id="plot4Legend"></h6>
    </div>
</div>
<table class="table table-hover">
    <thead>
        <tr>
            <th>#</th>
            <th>Score</th>
            <th>Last Name</th>
            <th>First Name</th>
            <th>Statement</th>
            <th class="text-center">Full Statement</th>
            <th>Age</th>
            <th>Race</th>
            <th>Date</th>
            <th class="text-center">Inmate Details</th>
        </tr>
    </thead>
    <tbody>
        {% for item in result %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ '%0.3f'| format(item.value|float) }}</td>
            <td>{{ item.surename }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.stm }}</td>
            <td class="text-center"><a href="{{ url_for('inmate_details', inmate_id=item.index) }}"><span class="glyphicon glyphicon-file"></span></a></td>
            <td>{{ item.age }}</td>
            <td>{{ item.race }}</td>
            <td>{{ item.date }}</td>
            <td class="text-center"><a href="{{ item.info_link }}" target="_blank"><span class="glyphicon glyphicon-list-alt"></span></a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
